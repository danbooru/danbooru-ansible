limit_req_zone $binary_remote_addr zone=users:16m rate=5r/s;
limit_req_zone $binary_remote_addr zone=posts:16m rate=10r/s;
limit_req_status 429;

server {
  listen 443 ssl http2 default_server;
  server_name danbooru.donmai.us;

  ssl_certificate /etc/nginx/ssl/danbooru.chain.pem;
  ssl_certificate_key /etc/nginx/ssl/danbooru.key;

  include /etc/nginx/conf.d/common.conf;
}

server {
  listen 443 ssl http2;
  server_name safebooru.donmai.us;

  ssl_certificate /etc/nginx/ssl/safebooru.chain.pem;
  ssl_certificate_key /etc/nginx/ssl/safebooru.key;
	
  include /etc/nginx/conf.d/common.conf;
}

server {
  listen 443 ssl http2;
  server_name {{ inventory_hostname }};

  ssl_certificate /etc/letsencrypt/live/{{ inventory_hostname }}/fullchain.pem; # managed by Certbot
  ssl_certificate_key /etc/letsencrypt/live/{{ inventory_hostname }}/privkey.pem; # managed by Certbot

  include /etc/nginx/conf.d/common.conf;

  allow 173.245.48.0/20;
  allow 103.21.244.0/22;
  allow 103.22.200.0/22;
  allow 103.31.4.0/22;
  allow 141.101.64.0/18;
  allow 108.162.192.0/18;
  allow 190.93.240.0/20;
  allow 188.114.96.0/20;
  allow 197.234.240.0/22;
  allow 198.41.128.0/17;
  allow 162.158.0.0/15;
  allow 104.16.0.0/12;
  allow 172.64.0.0/13;
  allow 131.0.72.0/22;
  allow 2400:cb00::/32;
  allow 2606:4700::/32;
  allow 2803:f800::/32;
  allow 2405:b500::/32;
  allow 2405:8100::/32;
  allow 2a06:98c0::/29;
  allow 2c0f:f248::/32;

  deny all;
}

# redirect HTTP to HTTPS.
server {
  listen 80;
  server_name safebooru.donmai.us danbooru.donmai.us kagamihara.donmai.us saitou.donmai.us shima.donmai.us;
  return 301 https://$host$request_uri;
}

# redirect donmai.us and www.donmai.us to danbooru.donmai.us.
server {
  listen 80;
  listen 443 ssl;
  server_name donmai.us	www.donmai.us;
  return 301 https://danbooru.donmai.us$request_uri;
}
      
upstream app_server {
  server unix:/tmp/.unicorn.sock fail_timeout=0;
}
